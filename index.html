void loop() {
  if(millis()-lastSend>=sendInterval){
    lastSend = millis();

    // Leer sensores
    int rawCO2 = leerSensor(PIN_MQ135);
    int rawCO  = leerSensor(PIN_MQ9);
    float co2ppm = rawCO2*factorCO2*1.21*1.2;
    float coppm  = rawCO*factorCO;
    unsigned long t = millis();

    // Guardar siempre en SPIFFS
    guardarLecturaSPIFFS(co2ppm, coppm, t);

    // Intentar enviar datos pendientes primero
    enviarPendientes();
  }
}

// Enviar todas las lecturas pendientes
void enviarPendientes(){
  if(WiFi.status() != WL_CONNECTED) return;
  File file = SPIFFS.open("/pendientes.txt", FILE_READ);
  if(!file) return;

  String buffer;
  while(file.available()){
    String linea = file.readStringUntil('\n');
    int idx1 = linea.indexOf(',');
    int idx2 = linea.lastIndexOf(',');
    if(idx1==-1 || idx2==-1) continue;

    unsigned long t = linea.substring(0, idx1).toInt();
    float co2 = linea.substring(idx1+1, idx2).toFloat();
    float co  = linea.substring(idx2+1).toFloat();

    if(enviarFirebase(co2, co, t)){ // solo eliminar si fue exitoso
      continue;
    } else {
      break; // si falla, detener para intentar después
    }
  }
  file.close();
  SPIFFS.remove("/pendientes.txt");
}

// Modificar enviarFirebase para indicar éxito
bool enviarFirebase(float co2, float co, unsigned long t){
  if(WiFi.status() != WL_CONNECTED) return false;

  HTTPClient http;
  String url = firebaseHost + "sensores.json?auth=" + apiKey;
  http.begin(url);
  http.addHeader("Content-Type", "application/json");

  StaticJsonDocument<250> doc;
  doc["co2"] = co2;
  doc["co"] = co;
  doc["last_update"] = t;
  String json;
  serializeJson(doc, json);

  int code = http.PUT(json);
  http.end();
  return (code>=200 && code<300);
}
