<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Monitor IoT</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    /* Estilos Simplificados y Elegantes */
    body { font-family: sans-serif; background: #1e1e2f; color: #fff; text-align: center; padding: 20px; }
    .status-box { padding: 8px 20px; border-radius: 20px; font-weight: bold; margin-bottom: 20px; display: inline-block; }
    .ok { background: #00d25b20; color: #00d25b; border: 1px solid #00d25b; }
    .fail { background: #fd5d9320; color: #fd5d93; border: 1px solid #fd5d93; }
    
    .charts-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 20px; }
    .chart-card { background: #27293d; padding: 20px; border-radius: 10px; width: 30%; min-width: 300px; }
    canvas { width: 100% !important; height: 200px !important; }
    
    .value-display { font-size: 2em; margin: 10px 0; font-weight: bold; }
    .text-co2 { color: #00d25b; }
    .text-co { color: #ff8d72; }

    /* Controles */
    .controls { background: #2b2d42; padding: 15px; border-radius: 10px; display: inline-block; margin-top: 30px; }
    button { background: #1d8cf8; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0b6ecc; }
    button:disabled { background: #555; }
</style>
</head>
<body>

<h1>Monitor de Gases</h1>
<div id="status" class="status-box fail">Conectando...</div>

<div class="charts-row">
    <div class="chart-card">
        <h3>COâ‚‚ (En Vivo)</h3>
        <div id="co2_val" class="value-display text-co2">---</div>
        <canvas id="chartCO2"></canvas>
    </div>
    <div class="chart-card">
        <h3>CO (En Vivo)</h3>
        <div id="co_val" class="value-display text-co">---</div>
        <canvas id="chartCO"></canvas>
    </div>
</div>

<div class="controls">
    <h3>Descargar Historial Offline</h3>
    <label>Ãšltimos <span id="timeVal">10</span> minutos</label>
    <input type="range" id="timeSlider" min="1" max="60" value="10" oninput="document.getElementById('timeVal').innerText=this.value">
    <button id="btnHist" onclick="cargarHistorial()">Ver Historial</button>
</div>

<div class="charts-row">
    <div class="chart-card" style="width: 45%;">
        <h3>Historial COâ‚‚</h3>
        <canvas id="histChartCO2"></canvas>
    </div>
    <div class="chart-card" style="width: 45%;">
        <h3>Historial CO</h3>
        <canvas id="histChartCO"></canvas>
    </div>
</div>

<script>
const dbUrl = "https://carro-f8554-default-rtdb.firebaseio.com/";
const apiKey = "AIzaSyDPf9ZKkIa66_Uw4hxE0KnZ9vWcxVlocvCo"; 

// --- GRÃFICAS CONFIG ---
const commonOpts = { 
    responsive: true, maintainAspectRatio: false, animation: false,
    scales: { x: { ticks: { color: '#aaa', maxTicksLimit: 5 } }, y: { beginAtZero: true, ticks: { color: '#aaa' } } }
};

// VIVO
const cCO2 = new Chart(document.getElementById('chartCO2'), { type: 'line', data: { labels: [], datasets: [{ data: [], borderColor: '#00d25b', tension: 0.4 }] }, options: commonOpts });
const cCO = new Chart(document.getElementById('chartCO'), { type: 'line', data: { labels: [], datasets: [{ data: [], borderColor: '#ff8d72', tension: 0.4 }] }, options: commonOpts });

// HISTORIAL
const hCO2 = new Chart(document.getElementById('histChartCO2'), { type: 'bar', data: { labels: [], datasets: [{ data: [], backgroundColor: '#00d25b' }] }, options: commonOpts });
const hCO = new Chart(document.getElementById('histChartCO'), { type: 'bar', data: { labels: [], datasets: [{ data: [], backgroundColor: '#ff8d72' }] }, options: commonOpts });

let lastUpdate = 0;

// --- LÃ“GICA EN VIVO ---
function updateLive() {
    fetch(dbUrl + "sensores.json?auth=" + apiKey)
    .then(r => r.json())
    .then(d => {
        if(!d) return;
        
        // 1. Convertir Timestamp UTC a Hora Local automÃ¡ticamente
        const ts = Number(d.last_update); 
        const date = new Date(ts); // El navegador detecta que es UTC y lo pasa a local
        const timeStr = date.toLocaleTimeString();

        document.getElementById("co2_val").innerText = parseFloat(d.co2).toFixed(1);
        document.getElementById("co_val").innerText = parseFloat(d.co).toFixed(1);

        // Si el timestamp es nuevo, actualizamos grÃ¡fica y estado
        if(ts !== lastUpdate) {
            lastUpdate = ts;
            document.getElementById("status").className = "status-box ok";
            document.getElementById("status").innerText = "En LÃ­nea ðŸŸ¢";

            addData(cCO2, timeStr, d.co2);
            addData(cCO, timeStr, d.co);
        }
    })
    .catch(() => {
        document.getElementById("status").className = "status-box fail";
        document.getElementById("status").innerText = "Desconectado ðŸ”´";
    });
}

function addData(chart, label, data) {
    chart.data.labels.push(label);
    chart.data.datasets[0].data.push(data);
    if(chart.data.labels.length > 15) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
    }
    chart.update();
}

// --- LÃ“GICA HISTORIAL ---
function cargarHistorial() {
    const btn = document.getElementById("btnHist");
    btn.disabled = true; btn.innerText = "Cargando...";

    const mins = document.getElementById("timeSlider").value;
    // Calculamos el tiempo de corte (Ahora - X minutos)
    // Date.now() es UTC. El timestamp de Firebase es UTC. Coinciden perfecto.
    const cutoff = Date.now() - (mins * 60 * 1000);

    fetch(`${dbUrl}historial.json?auth=${apiKey}&orderBy="timestamp"&limitToLast=300`)
    .then(r => r.json())
    .then(d => {
        if(!d) return alert("Sin datos.");
        
        let arr = Object.values(d);
        // Filtrar por tiempo real
        arr = arr.filter(x => x.timestamp >= cutoff);
        arr.sort((a,b) => a.timestamp - b.timestamp);

        if(arr.length === 0) return alert("No hay datos recientes.");

        // Generar etiquetas (El navegador convierte UTC a Hora Local aquÃ­)
        const labels = arr.map(x => new Date(x.timestamp).toLocaleTimeString());
        
        hCO2.data.labels = labels;
        hCO2.data.datasets[0].data = arr.map(x => x.co2);
        hCO2.update();

        hCO.data.labels = labels;
        hCO.data.datasets[0].data = arr.map(x => x.co);
        hCO.update();
    })
    .catch(e => console.error(e))
    .finally(() => { btn.disabled = false; btn.innerText = "Ver Historial"; });
}

setInterval(updateLive, 2500); // Actualizar cada 2.5 seg
</script>
</body>
</html>
