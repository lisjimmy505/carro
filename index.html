<script>
function drawCharts() {
    if(chartCO2) chartCO2.destroy();
    if(chartCO) chartCO.destroy();

    // Función para encontrar índices de máximo y mínimo
    function maxMinIndices(data) {
        let maxIdx = 0, minIdx = 0;
        for(let i=0;i<data.length;i++){
            if(data[i] > data[maxIdx]) maxIdx = i;
            if(data[i] < data[minIdx]) minIdx = i;
        }
        return {maxIdx, minIdx};
    }

    chartCO2 = new Chart(ctxCO2, {
        type: 'line',
        data: {
            labels: historyData.map(d => d.time),
            datasets: [
                { label: 'CO2 (ppm)', data: historyData.map(d => d.co2), borderColor: 'lime', fill: false, tension: 0.1 }
            ]
        },
        options: {
            responsive: false,
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: 'white' } },
                tooltip: { enabled: true },
                afterDatasetsDraw: (chart) => {
                    const ctx = chart.ctx;
                    const dataset = chart.data.datasets[0].data;
                    const {maxIdx, minIdx} = maxMinIndices(dataset);

                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 14px Arial';

                    const xMax = chart.getDatasetMeta(0).data[maxIdx].x;
                    const yMax = chart.getDatasetMeta(0).data[maxIdx].y;
                    ctx.fillText(dataset[maxIdx].toFixed(1), xMax + 5, yMax - 5);

                    const xMin = chart.getDatasetMeta(0).data[minIdx].x;
                    const yMin = chart.getDatasetMeta(0).data[minIdx].y;
                    ctx.fillText(dataset[minIdx].toFixed(1), xMin + 5, yMin + 15);
                }
            },
            scales: {
                x: { ticks: { color: 'white' } },
                y: { min: 0, ticks: { color: 'white' }, beginAtZero: true }
            }
        }
    });

    chartCO = new Chart(ctxCO, {
        type: 'line',
        data: {
            labels: historyData.map(d => d.time),
            datasets: [
                { label: 'CO (ppm)', data: historyData.map(d => d.co), borderColor: 'yellow', fill: false, tension: 0.1 }
            ]
        },
        options: {
            responsive: false,
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: 'white' } },
                tooltip: { enabled: true },
                afterDatasetsDraw: (chart) => {
                    const ctx = chart.ctx;
                    const dataset = chart.data.datasets[0].data;
                    const {maxIdx, minIdx} = maxMinIndices(dataset);

                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 14px Arial';

                    const xMax = chart.getDatasetMeta(0).data[maxIdx].x;
                    const yMax = chart.getDatasetMeta(0).data[maxIdx].y;
                    ctx.fillText(dataset[maxIdx].toFixed(2), xMax + 5, yMax - 5);

                    const xMin = chart.getDatasetMeta(0).data[minIdx].x;
                    const yMin = chart.getDatasetMeta(0).data[minIdx].y;
                    ctx.fillText(dataset[minIdx].toFixed(2), xMin + 5, yMin + 15);
                }
            },
            scales: {
                x: { ticks: { color: 'white' } },
                y: { min: 0, ticks: { color: 'white' }, beginAtZero: true }
            }
        }
    });
}
</script>
