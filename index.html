<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Monitor simple ESP32 - Estado y 10% cambio</title>
<style>
  body { font-family: Arial, sans-serif; background:#4A0070; color:#fff; text-align:center; padding:20px; }
  .status { display:inline-block; padding:8px 14px; border-radius:10px; margin-bottom:18px; font-weight:700; }
  .ok { background:#25D366; color:#000; }
  .fail { background:#FF4C4C; color:#000; }
  .card{ background: rgba(255,255,255,0.08); padding:16px; border-radius:10px; width:320px; margin:8px auto; }
  table{ margin:8px auto; font-size:18px; }
</style>
</head>
<body>

<h1>Monitor simple ESP32</h1>
<div id="status" class="status fail">ESP32 Desconectado ✗</div>

<div class="card">
  <h2>MQ135 (CO₂)</h2>
  <div id="co2_val">---</div>
</div>

<div class="card">
  <h2>MQ9 (CO)</h2>
  <div id="co_val">---</div>
</div>

<script>
/* ---------- CONFIG ---------- */
const firebaseURL = "https://carro-f8554-default-rtdb.firebaseio.com/sensores.json"; // cambiar si hace falta
const FETCH_INTERVAL_MS = 2000;   // cada cuánto preguntar a Firebase
const CONNECTION_TIMEOUT_MS = 5000; // si no llega nada en este tiempo -> desconectado
const CHANGE_THRESHOLD = 0.10;    // 10% mínimo para mostrar nuevo valor
/* ---------------------------- */

let lastShownCO2 = null;
let lastShownCO = null;
let lastESPUpdate = 0; // momento (ms) en que recibimos datos OK por última vez

async function obtenerDatos() {
  try {
    const res = await fetch(firebaseURL, {cache: "no-store"});
    if (!res.ok) throw new Error("HTTP " + res.status);

    const data = await res.json();
    if (!data) return; // no hay payload

    // Actualizamos la marca de tiempo de última recepción exitosa
    lastESPUpdate = Date.now();

    // Parsear valores (asegurar que sean números)
    const co2 = Number(data.co2);
    const co = Number(data.co);

    // Solo mostrar si hay número válido
    if (!Number.isFinite(co2) || !Number.isFinite(co)) return;

    // Mostrar solo si cambio >= 10% respecto al último mostrado
    if (lastShownCO2 === null || Math.abs((co2 - lastShownCO2) / (lastShownCO2 || co2)) >= CHANGE_THRESHOLD) {
      document.getElementById("co2_val").innerText = co2.toFixed(1) + " ppm";
      lastShownCO2 = co2;
    }

    if (lastShownCO === null || Math.abs((co - lastShownCO) / (lastShownCO || co)) >= CHANGE_THRESHOLD) {
      document.getElementById("co_val").innerText = co.toFixed(2) + " ppm";
      lastShownCO = co;
    }

  } catch (err) {
    // En caso de error de red o respuesta, no actualizamos lastESPUpdate
    console.log("Error fetch Firebase:", err);
  }
}

function checkConnection() {
  const diff = Date.now() - lastESPUpdate;
  const statusEl = document.getElementById("status");
  if (diff < CONNECTION_TIMEOUT_MS) {
    statusEl.className = "status ok";
    statusEl.innerText = "ESP32 Conectado ✓";
  } else {
    statusEl.className = "status fail";
    statusEl.innerText = "ESP32 Desconectado ✗";
  }
}

/* Init: hacer una consulta inmediata y luego periódica */
obtenerDatos();
setInterval(obtenerDatos, FETCH_INTERVAL_MS);
setInterval(checkConnection, 1000);
</script>

</body>
</html>
