<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control Carro & Monitor Gases</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    font-family: "Arial", sans-serif;
    background: #2c3e50;
    color: white;
    text-align: center;
    margin: 0; padding: 20px;
}

/* --- ESTILOS PANEL DE CONTROL --- */
.control-panel {
    background: rgba(0,0,0,0.3);
    padding: 20px;
    border-radius: 15px;
    margin: 20px auto;
    max-width: 400px;
    border: 2px solid #ecf0f1;
}

.btn-control {
    width: 100%;
    padding: 15px;
    font-size: 22px;
    font-weight: bold;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    margin: 10px 0;
    transition: transform 0.1s;
}

.btn-control:active { transform: scale(0.95); }
.btn-up { background: #2ecc71; color: white; } /* Verde */
.btn-down { background: #3498db; color: white; } /* Azul */
.btn-stop { background: #e74c3c; color: white; } /* Rojo */

/* --- ESTILOS MONITOR --- */
.status-box { display: inline-block; padding: 10px 20px; border-radius: 12px; font-size: 18px; margin-bottom: 20px; }
.ok { background: #27ae60; }
.fail { background: #c0392b; }

.card-container { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
.card { background: rgba(255,255,255,0.1); padding: 15px; width: 300px; border-radius: 10px; }

canvas { max-height: 300px; width: 100%; }
</style>
</head>

<body>

<h1>Carro Robot IoT</h1>
<div id="status" class="status-box fail">Desconectado</div>

<div class="control-panel">
    <h2>üéÆ Control Remoto</h2>
    <button class="btn-control btn-up" onclick="enviarComando('ADELANTE')">‚¨Ü AVANZAR</button>
    <button class="btn-control btn-stop" onclick="enviarComando('QUIETO')">‚èπ DETENER</button>
    <button class="btn-control btn-down" onclick="enviarComando('ATRAS')">‚¨á RETROCEDER</button>
</div>

<div class="card-container">
    <div class="card">
        <h3>CO‚ÇÇ (MQ135)</h3>
        <h2 id="co2_val">---</h2>
    </div>
    <div class="card">
        <h3>CO (MQ9)</h3>
        <h2 id="co_val">---</h2>
    </div>
</div>

<div style="margin-top:30px; max-width: 800px; margin-left: auto; margin-right: auto;">
    <canvas id="mainChart"></canvas>
</div>

<script>
const dbUrl = "https://carro-f8554-default-rtdb.firebaseio.com/";

// --- FUNCI√ìN PARA ENVIAR COMANDOS ---
function enviarComando(accion) {
    // Enviamos un PUT para sobrescribir el comando actual
    fetch(dbUrl + "comando.json", {
        method: 'PUT',
        body: JSON.stringify(accion),
        headers: { 'Content-Type': 'application/json' }
    })
    .then(() => console.log("Comando enviado:", accion))
    .catch(err => console.error("Error enviando comando:", err));
}

// --- LECTURA DE SENSORES ---
let lastUpdate = 0;
const ctx = document.getElementById('mainChart').getContext('2d');
const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [
            { label: 'CO2', borderColor: '#2ecc71', data: [] },
            { label: 'CO', borderColor: '#f1c40f', data: [] }
        ]
    },
    options: { responsive: true }
});

function actualizarDatos() {
    fetch(dbUrl + "sensores.json")
    .then(res => res.json())
    .then(data => {
        if(!data) return;
        
        // Actualizar UI
        document.getElementById("co2_val").innerText = parseFloat(data.co2).toFixed(1) + " ppm";
        document.getElementById("co_val").innerText = parseFloat(data.co).toFixed(1) + " ppm";

        // Chequeo conexi√≥n (si last_update cambia)
        if(data.last_update !== lastUpdate) {
            lastUpdate = data.last_update;
            document.getElementById("status").className = "status-box ok";
            document.getElementById("status").innerText = "Conectado ‚úì";
            
            // Agregar a gr√°fica
            const timeStr = new Date(data.last_update).toLocaleTimeString();
            if(chart.data.labels.length > 10) { // Mantener solo √∫ltimos 10 puntos
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
                chart.data.datasets[1].data.shift();
            }
            chart.data.labels.push(timeStr);
            chart.data.datasets[0].data.push(data.co2);
            chart.data.datasets[1].data.push(data.co);
            chart.update();
        } else {
            // Si lleva mucho tiempo sin cambiar...
            if(Date.now() - data.last_update > 8000) {
                document.getElementById("status").className = "status-box fail";
                document.getElementById("status").innerText = "Desconectado ‚úó";
            }
        }
    });
}

// Actualizar datos cada 2 segundos
setInterval(actualizarDatos, 2000);

// Asegurar que arranque detenido
window.onload = () => enviarComando("QUIETO");
</script>

</body>
</html>
