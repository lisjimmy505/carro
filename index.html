<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control Carro & Monitor Gases</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #1e1e2f;
    color: #e0e0e0;
    text-align: center;
    margin: 0; padding: 20px;
}

h1 { margin-bottom: 10px; }

/* --- ESTILOS PANEL DE CONTROL --- */
.control-panel {
    background: #27293d;
    padding: 20px;
    border-radius: 15px;
    margin: 20px auto;
    max-width: 400px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    border: 1px solid #3d3f53;
}

.btn-control {
    width: 100%;
    padding: 15px;
    font-size: 18px;
    font-weight: bold;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    margin: 8px 0;
    color: white;
    transition: opacity 0.2s;
}
.btn-control:hover { opacity: 0.9; }
.btn-up { background: #00d25b; box-shadow: 0 4px 10px rgba(0, 210, 91, 0.3); }
.btn-down { background: #1f8ef1; box-shadow: 0 4px 10px rgba(31, 142, 241, 0.3); }
.btn-stop { background: #fd5d93; box-shadow: 0 4px 10px rgba(253, 93, 147, 0.3); }

/* --- ESTADO CONEXI√ìN --- */
.status-box { 
    display: inline-block; 
    padding: 8px 20px; 
    border-radius: 20px; 
    font-size: 16px; 
    font-weight: bold;
    margin-bottom: 20px;
    transition: all 0.3s;
}
.ok { background: rgba(0, 210, 91, 0.2); color: #00d25b; border: 1px solid #00d25b; }
.fail { background: rgba(253, 93, 147, 0.2); color: #fd5d93; border: 1px solid #fd5d93; }

/* --- CONTENEDOR GR√ÅFICAS --- */
.charts-row {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
}

.chart-card {
    background: #27293d;
    padding: 20px;
    border-radius: 15px;
    width: 45%;
    min-width: 350px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.value-display {
    font-size: 32px;
    font-weight: bold;
    margin: 10px 0;
}

/* Colores de texto para valores */
.text-co2 { color: #00d25b; }
.text-co { color: #ff8d72; }

canvas {
    width: 100% !important;
    height: 300px !important;
}
</style>
</head>

<body>

<h1>Carro Robot IoT</h1>
<div id="status" class="status-box fail">Esperando datos...</div>

<div class="control-panel">
    <h3>üéÆ Mando a Distancia</h3>
    <button class="btn-control btn-up" onmousedown="enviarComando('ADELANTE')">‚¨Ü AVANZAR</button>
    <button class="btn-control btn-stop" onmousedown="enviarComando('QUIETO')">‚èπ DETENER</button>
    <button class="btn-control btn-down" onmousedown="enviarComando('ATRAS')">‚¨á RETROCEDER</button>
</div>

<div class="charts-row">
    <div class="chart-card">
        <h3>MQ135 (CO‚ÇÇ)</h3>
        <div id="co2_val" class="value-display text-co2">--- ppm</div>
        <canvas id="chartCO2"></canvas>
    </div>

    <div class="chart-card">
        <h3>MQ9 (CO)</h3>
        <div id="co_val" class="value-display text-co">--- ppm</div>
        <canvas id="chartCO"></canvas>
    </div>
</div>

<script>
// ---------------- CONFIGURACI√ìN ----------------
const dbUrl = "https://carro-f8554-default-rtdb.firebaseio.com/";

// Variables de control de conexi√≥n
let lastFirebaseUpdate = 0; // Marca de tiempo que viene de Firebase
let lastLocalReceipt = Date.now(); // Hora local de la √∫ltima recepci√≥n v√°lida

// ---------------- COMANDOS MOTORES ----------------
function enviarComando(accion) {
    fetch(dbUrl + "comando.json", {
        method: 'PUT',
        body: JSON.stringify(accion),
        headers: { 'Content-Type': 'application/json' }
    })
    .catch(err => console.error("Error enviando comando:", err));
}

// ---------------- CONFIGURACI√ìN GR√ÅFICAS ----------------
// Gr√°fica CO2
const ctxCO2 = document.getElementById('chartCO2').getContext('2d');
const chartCO2 = new Chart(ctxCO2, {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            label: 'CO‚ÇÇ (ppm)',
            borderColor: '#00d25b', // Verde
            backgroundColor: 'rgba(0, 210, 91, 0.1)',
            borderWidth: 2,
            pointRadius: 3,
            fill: true,
            data: [],
            tension: 0.3
        }]
    },
    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
});

// Gr√°fica CO
const ctxCO = document.getElementById('chartCO').getContext('2d');
const chartCO = new Chart(ctxCO, {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            label: 'CO (ppm)',
            borderColor: '#ff8d72', // Naranja
            backgroundColor: 'rgba(255, 141, 114, 0.1)',
            borderWidth: 2,
            pointRadius: 3,
            fill: true,
            data: [],
            tension: 0.3
        }]
    },
    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
});

// ---------------- L√ìGICA DE ACTUALIZACI√ìN ----------------
function actualizarDatos() {
    fetch(dbUrl + "sensores.json")
    .then(res => res.json())
    .then(data => {
        if(!data) return;

        const serverTime = Number(data.last_update); // Timestamp del ESP32
        const co2 = parseFloat(data.co2);
        const co = parseFloat(data.co);

        // Actualizamos textos siempre que haya dato
        document.getElementById("co2_val").innerText = co2.toFixed(1) + " ppm";
        document.getElementById("co_val").innerText = co.toFixed(1) + " ppm";

        // 1. VERIFICAR SI ES UN DATO NUEVO
        if(serverTime !== lastFirebaseUpdate) {
            // Es un dato nuevo
            lastFirebaseUpdate = serverTime;
            lastLocalReceipt = Date.now(); // Reiniciamos el "reloj de la muerte" (watchdog)
            
            // Actualizar estado visual a OK inmediatamente
            actualizarEstadoVisual(true);

            // Actualizar gr√°ficas
            const timeStr = new Date(serverTime).toLocaleTimeString();
            addData(chartCO2, timeStr, co2);
            addData(chartCO, timeStr, co);
        }
    })
    .catch(err => console.error("Error fetching:", err));
}

// Funci√≥n auxiliar para a√±adir datos y mantener la gr√°fica limpia (max 15 ptos)
function addData(chart, label, data) {
    chart.data.labels.push(label);
    chart.data.datasets.forEach((dataset) => {
        dataset.data.push(data);
    });
    if (chart.data.labels.length > 15) {
        chart.data.labels.shift();
        chart.data.datasets.forEach((dataset) => {
            dataset.data.shift();
        });
    }
    chart.update();
}

function actualizarEstadoVisual(conectado) {
    const statusDiv = document.getElementById("status");
    if (conectado) {
        statusDiv.className = "status-box ok";
        statusDiv.innerText = "ESP32 Conectado üü¢";
    } else {
        statusDiv.className = "status-box fail";
        statusDiv.innerText = "ESP32 Desconectado üî¥";
    }
}

// ---------------- WATCHDOG DE CONEXI√ìN ----------------
// Esta funci√≥n corre independientemente cada 1 segundo
function checkConnectionWatchdog() {
    const now = Date.now();
    // Si han pasado m√°s de 10 segundos (10000ms) desde la √∫ltima recepci√≥n v√°lida
    if (now - lastLocalReceipt > 10000) {
        actualizarEstadoVisual(false);
    } else {
        // Si estamos dentro del tiempo, aseguramos que diga conectado
        // (Esto evita que se quede en rojo si el fetch falla moment√°neamente pero estamos en rango)
        actualizarEstadoVisual(true);
    }
}

// Intervalos
setInterval(actualizarDatos, 2000);          // Consultar Firebase cada 2s
setInterval(checkConnectionWatchdog, 1000);  // Revisar tiempo local cada 1s

// Init
window.onload = () => enviarComando("QUIETO");
</script>

</body>
</html>
